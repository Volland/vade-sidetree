image: rust:latest

services:
  - name: trufflesuite/ganache-cli:latest
    alias: ganache
    command:
      [
        'ganache-cli',
        '-h',
        '0.0.0.0',
        '-m',
        'beauty satoshi orphan shock since budget make diagram almost caution cactus blouse',
      ]
  - name: ipfs/go-ipfs:latest
    alias: ipfs
  - name: mongo:latest
    alias: mongo
  - name: docker.slock.it/equs/interop/sidetree-node:latest
    alias: sidetree
    command: ["/bin/sh", "-c", "sleep 2 && yarn start"]
    entrypoint: [""]

variables:
  SIDETREE_API_URL: http://sidetree:3000/1.0/
  ETH_RPC: http://ganache:8545
  MNEMONIC: beauty satoshi orphan shock since budget make diagram almost caution cactus blouse
  WRITE_TO_CAS_AND_BLOCKCHAIN_AFTER_EVERY_OPERATION: "true"
  APPLICATION_WALLET_PRIVATE_KEY: ""

stages:
  # - build
  - test_unit

before_script:
  - git config --global url."https://gitlab-ci-token:${CI_JOB_TOKEN}@git.slock.it/".insteadOf 'ssh://git@git.slock.it/'

# build:
#   stage: build
#   script:
#     - apt-get update
#     - apt-get install -y clang
#     - cd ..
#     - rm -rf vade
#     - git clone https://gitlab-ci-token:${CI_JOB_TOKEN}@git.slock.it/equs/interop/vade/vade.git --branch develop
#     - cd vade-sidetree
#     - cargo build --release --verbose
#   artifacts:
#     paths:
#       - ./target
#     expire_in: 1 hour

test_unit:
 stage: test_unit
 script:
   - apt-get update
   - apt-get install -y clang
   - mkdir -p .git/hooks
   - RUST_LOG=trace cargo test --verbose -- --nocapture
